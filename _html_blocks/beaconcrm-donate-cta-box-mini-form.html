<!-- PANGEA TRUST – DONATION BLOCK (Divi Code module, single file) -->
<!-- Author Amer Kawar -> https://wildamer.com -->

<div id="pangea-donate" class="pgt-wrap">
  <div class="pgt-card">
    <header class="pgt-header">
      <h3 class="pgt-title">Make a donation</h3>
      <p class="pgt-sub">Pick your currency, frequency, and amount</p>
    </header>

    <!-- Frequency: equal-width tabs -->
    <div class="pgt-section">
      <div class="pgt-tabs pgt-tabs--row" role="tablist" aria-label="Donation frequency">
        <button class="pgt-tab pgt-btn-frequency" data-frequency="single"   type="button" aria-selected="false">Single</button>
        <button class="pgt-tab pgt-btn-frequency" data-frequency="monthly"  type="button" aria-selected="true">Monthly</button>
        <button class="pgt-tab pgt-btn-frequency" data-frequency="annual"   type="button" aria-selected="false">Annual</button>
      </div>
    </div>

    <!-- Amount + currency dropdown -->
    <div class="pgt-amount">
      <div class="pgt-amount-header">
        <div class="pgt-amount-label">Amount</div>
        <label class="pgt-currency-select-label" for="pgt-currency-select" aria-label="Currency"></label>
        <select id="pgt-currency-select" class="pgt-select" aria-label="Currency">
          <option value="GBP">GBP £</option>
          <option value="EUR">EUR €</option>
          <option value="USD">USD $</option>
        </select>
      </div>

      <!-- Amount presets grid -->
      <div class="pgt-tabs pgt-tabs--grid" id="pgt-amount-buttons" role="group" aria-label="Preset amounts">
        <!-- Filled immediately with DEFAULT_PRESETS, then updated after fetch -->
      </div>

      <!-- Custom amount (hidden until link is clicked) -->
      <div class="pgt-amount-custom">
        <button id="pgt-toggle-custom" class="pgt-link" type="button" aria-expanded="false" aria-controls="pgt-custom-wrap">Custom amount</button>
        <div id="pgt-custom-wrap" class="pgt-input-wrap" hidden style="display:none;">
          <span id="pgt-currency-symbol" aria-hidden="true">£</span>
          <input id="pgt-custom-amount" type="number" min="1" step="1" inputmode="decimal" placeholder="0" />
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="pgt-actions">
      <button id="pgt-next" class="pgt-btn pgt-btn-next" type="button" aria-label="Continue to secure form" disabled>Donate now →</button>
      <div class="pgt-note">You’ll be taken to our secure donation form to complete your gift.</div>
    </div>
  </div>
</div>

<style>
/* ---- Base / tokens ---- */
#pangea-donate { --pgt-bg:#ffffff; --pgt-text:#222; --pgt-sub:#6b7280; --pgt-brand:#465833; --pgt-brand-600:#3a492a; --pgt-border:#e5e7eb; --pgt-muted:#9ca3af; --pgt-focus:#1f2937; --pgt-primary:#FF7B1A; --pgt-primary-600:#e66000; font-family:inherit; }
#pangea-donate .pgt-card { background:var(--pgt-bg); border:1px solid var(--pgt-border); border-radius:16px; padding:24px; box-shadow:0 4px 20px rgba(0,0,0,.06); }
#pangea-donate .pgt-title { margin:0 0 2px; font-size:22px; line-height:1.2; color:var(--pgt-text); }
#pangea-donate .pgt-sub { margin:0 0 12px; color:var(--pgt-sub); }
#pangea-donate .pgt-section, #pangea-donate .pgt-amount { margin-bottom:12px; }
#pangea-donate .pgt-amount-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
#pangea-donate .pgt-amount-label { font-weight:600; }

/* ---- DRY tab system (shared by frequency row & amount grid) ---- */
#pangea-donate .pgt-tabs { border:1px solid var(--pgt-border); border-radius:8px; overflow:hidden; background:#fff; }
#pangea-donate .pgt-tab { appearance:none; background:#fff; color:#111; font-weight:600; padding:10px 12px; cursor:pointer; border:none; transition:background .15s ease, color .15s ease, transform .15s ease; width:100%; }
#pangea-donate .pgt-tab:hover { transform:translateY(-1px); }
#pangea-donate .pgt-tab:focus-visible { outline:2px solid var(--pgt-focus); outline-offset:2px; }
/* Selected/active state: unify for both frequency (aria-selected) & amount (aria-pressed) */
#pangea-donate .pgt-tab[aria-selected="true"],
#pangea-donate .pgt-tab[aria-pressed="true"] { background:var(--pgt-brand); color:#fff; cursor:default; }
#pangea-donate .pgt-tab[aria-selected="true"]:hover,
#pangea-donate .pgt-tab[aria-pressed="true"]:hover { transform:none; }

/* Row variant (frequency) */
#pangea-donate .pgt-tabs--row { display:flex; gap:0; width:100%; }
#pangea-donate .pgt-tabs--row .pgt-tab + .pgt-tab { border-left:1px solid var(--pgt-border); } /* internal separators only */

/* Grid variant (amounts) — container draws outer border; tabs draw ONLY internal separators */
#pangea-donate .pgt-tabs--grid { display:grid; grid-template-columns:repeat(3, 1fr); }
#pangea-donate .pgt-tabs--grid .pgt-tab { border-right:1px solid var(--pgt-border); border-bottom:1px solid var(--pgt-border); }
#pangea-donate .pgt-tabs--grid .pgt-tab:nth-child(3n) { border-right:none; }
#pangea-donate .pgt-tabs--grid .pgt-tab:nth-last-child(-n+3) { border-bottom:none; }

/* Select / dropdown */
#pangea-donate .pgt-select { border:1px solid var(--pgt-border); border-radius:8px; padding:6px 10px; background:#fff; font-weight:600; }

/* Custom amount */
#pangea-donate .pgt-input-wrap { display:flex; align-items:center; gap:6px; border:1px solid var(--pgt-border); border-radius:8px; padding:8px 10px; max-width:240px; margin-top:8px; }
#pangea-donate #pgt-currency-symbol { display:inline-block; min-width:1ch; color:var(--pgt-sub); }
#pangea-donate #pgt-custom-amount { width:100%; border:none; outline:none; font-size:16px; }
#pangea-donate .pgt-link { background:none; border:none; color:var(--pgt-brand); padding:0; font-weight:600; cursor:pointer; border-radius:0; text-decoration:underline; }
#pangea-donate .pgt-link:focus-visible { outline:2px solid var(--pgt-focus); outline-offset:2px; }

/* CTA */
#pangea-donate .pgt-actions { display:flex; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap; }
#pangea-donate .pgt-btn { border:1px solid var(--pgt-border); border-radius:8px; padding:8px 12px; font-weight:600; cursor:pointer; background:#fff; }
#pangea-donate .pgt-btn-next { background:var(--pgt-primary); color:#fff; border-color:var(--pgt-primary); }
#pangea-donate .pgt-btn-next:hover { background:var(--pgt-primary-600); border-color:var(--pgt-primary-600); }
#pangea-donate .pgt-btn-next[disabled] { background:#d1d5db; border-color:#d1d5db; color:#6b7280; cursor:not-allowed; }
#pangea-donate .pgt-note { color:var(--pgt-sub); font-size:13px; }

/* Responsive: stack amounts on phones (1 column) with proper borders */
@media (max-width:480px){
  #pangea-donate .pgt-title{font-size:19px}
  #pangea-donate .pgt-tabs--grid { grid-template-columns:1fr; }
  #pangea-donate .pgt-tabs--grid .pgt-tab { border-right:none; border-bottom:1px solid var(--pgt-border); }
  #pangea-donate .pgt-tabs--grid .pgt-tab:last-child { border-bottom:none; }

  /* Fix stacked amount borders on small screens */
  #pangea-donate .pgt-tabs--grid { grid-template-columns: 1fr; }

  /* Every amount gets only a bottom border… */
  #pangea-donate .pgt-tabs--grid .pgt-tab {
    border-right: none !important;
    border-bottom: 1px solid var(--pgt-border) !important;
  }

  /* …except the last of its type */
  #pangea-donate .pgt-tabs--grid .pgt-tab:last-of-type {
    border-bottom: none !important;
  }

  /* Make the Next button full width on small screens */
  #pangea-donate .pgt-actions {
    flex-direction: column;       /* stack items vertically */
    align-items: stretch;         /* let children fill the row */
  }
  #pangea-donate #pgt-next {
    width: 100%;                  /* span full container width */
    display: block;               /* ensure it behaves like a block */
    box-sizing: border-box;       /* include padding/border within width */
  }
}
</style>

<script>
(function(){
  const baseURL = "https://www.pangeatrust.org/test-beacon-donation-form/";
  const formsByCurrency = {
    GBP: { id:"57085719", symbol:"£" },
    EUR: { id:"694de004", symbol:"€" },
    USD: { id:"17a36966", symbol:"$" }
  };
  const DEFAULT_PRESETS = { single:[10,20,30], monthly:[5,10,15], annual:[50,100,200] };

  // Resolve currency via AJAX JSON endpoint. Fallback is GBP.
  async function fetchGeoCurrency(){
    const endpoint = "/wp-admin/admin-ajax.php?action=geoip_detect2_get_info_from_current_ip";
    try{
      const res = await fetch(endpoint, { credentials: "same-origin", cache: "no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const record = await res.json();
      // Prefer extra.currency_code (plugin example); accept USD/EUR/GBP only
      const code = String(
        (record && record.extra && (record.extra.currency_code || record.extra.currencyCode)) || ""
      ).toUpperCase();
      return (code === "USD" || code === "EUR" || code === "GBP") ? code : "GBP";
    }catch(_e){
      return "GBP";
    }
  }

  // Initial state uses GBP; we may update after AJAX
  let state = {
    currency: "GBP",
    frequency: "monthly",
    amountPresets: { ...DEFAULT_PRESETS },
    amountSelected: null
  };

  const wrap = document.getElementById("pangea-donate");
  const freqBtns = Array.from(wrap.querySelectorAll(".pgt-btn-frequency"));
  const amountBtnsWrap = document.getElementById("pgt-amount-buttons");
  const customWrap = document.getElementById("pgt-custom-wrap");
  const customToggle = document.getElementById("pgt-toggle-custom");
  const customAmountInput = document.getElementById("pgt-custom-amount");
  const currencySymbol = document.getElementById("pgt-currency-symbol");
  const currencySelect = document.getElementById("pgt-currency-select");
  const nextBtn = document.getElementById("pgt-next");

  currencySelect.value = state.currency;
  currencySymbol.textContent = formsByCurrency[state.currency].symbol;

  // Helpers
  function setSelected(btns, value, attr){
    btns.forEach(b=>{
      const v = b.dataset[attr];
      b.setAttribute("aria-selected", v === value ? "true" : "false");
    });
  }
  function renderFrequencyUI(){ setSelected(freqBtns, state.frequency, "frequency"); }

  function renderAmountPresets(){
    amountBtnsWrap.innerHTML = "";
    const group = (state.frequency === "single")
      ? state.amountPresets.single
      : (state.frequency === "annual")
        ? state.amountPresets.annual
        : state.amountPresets.monthly;

    const safeGroup = (Array.isArray(group) && group.length) ? group : DEFAULT_PRESETS[state.frequency];

    safeGroup.forEach(v=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "pgt-tab pgt-btn-amount";
      btn.textContent = `${formsByCurrency[state.currency].symbol}${Number(v)}`;
      btn.dataset.amount = String(v);
      btn.setAttribute("aria-pressed","false");
      btn.addEventListener("click", ()=>{
        Array.from(amountBtnsWrap.querySelectorAll(".pgt-btn-amount")).forEach(el=>el.setAttribute("aria-pressed","false"));
        btn.setAttribute("aria-pressed","true");
        state.amountSelected = Number(v);
        customAmountInput.value = "";
        updateNextButton();
      });
      amountBtnsWrap.appendChild(btn);
    });
    updateNextButton();
  }

  function parsePresetArray(arr){
    return (Array.isArray(arr) ? arr.map(o=>Number(o.value)).filter(n=>!isNaN(n)) : []);
  }

  async function fetchPresets(currency){
    const formId = formsByCurrency[currency].id;
    const url = `https://portal.beaconproducts.co.uk/v1/account/pangeatrust/form/${formId}?fp=x`;
    try{
      const res = await fetch(url, { credentials: "omit", cache: "no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();
      const donationSection = (data.sections || []).find(s=>s.key==="donation_amount");
      return {
        single:  parsePresetArray(donationSection?.preset_single_amounts),
        monthly: parsePresetArray(donationSection?.preset_monthly_amounts),
        annual:  parsePresetArray(donationSection?.preset_annual_amounts),
      };
    }catch(err){
      return { ...DEFAULT_PRESETS };
    }
  }

  async function onCurrencyChange(newCur){
    if(!formsByCurrency[newCur]) return;
    state.currency = newCur;
    currencySelect.value = newCur;
    currencySymbol.textContent = formsByCurrency[state.currency].symbol;
    state.amountSelected = null;
    customAmountInput.value = "";
    renderAmountPresets(); // defaults immediately
    state.amountPresets = await fetchPresets(state.currency);
    renderAmountPresets(); // update with live values
  }

  function onFrequencyChange(newFreq){
    state.frequency = newFreq;
    state.amountSelected = null;
    customAmountInput.value = "";
    renderFrequencyUI();
    renderAmountPresets();
  }

  function getChosenAmount(){
    const custom = parseFloat(customAmountInput.value);
    if(!isNaN(custom) && custom > 0) return Math.round(custom * 100) / 100;
    if(typeof state.amountSelected === "number") return state.amountSelected;
    return null;
  }

  function updateNextButton(){
    const amt = getChosenAmount();
    if(amt){ nextBtn.disabled = false; } else { nextBtn.disabled = true; }
  }

  function buildNextURL(){
    const params = new URLSearchParams();
    params.set("currency", state.currency); // keep explicit; Beacon can auto-geo if omitted
    params.set("bcn_donation_frequency", state.frequency);
    const amt = getChosenAmount();
    if(amt) params.set("bcn_donation_amount", String(amt));
    return `${baseURL}?${params.toString()}`;
  }

  // Events
  currencySelect.addEventListener("change", ()=> onCurrencyChange(currencySelect.value));
  freqBtns.forEach(btn=>{ btn.addEventListener("click", ()=> onFrequencyChange(btn.dataset.frequency)); });

  // Custom amount toggle
  function setCustomVisible(show){
    if(show){
      customWrap.hidden = false;
      customWrap.style.display = "flex";
      customToggle.textContent = "Hide custom amount";
      customToggle.setAttribute("aria-expanded","true");
      customAmountInput.focus();
    } else {
      customWrap.hidden = true;
      customWrap.style.display = "none";
      customToggle.textContent = "Custom amount";
      customToggle.setAttribute("aria-expanded","false");
    }
  }
  function isCustomVisible(){ return !customWrap.hidden && customWrap.style.display !== "none"; }

  customToggle.addEventListener("click", ()=>{
    setCustomVisible(!isCustomVisible());
  });

  customAmountInput.addEventListener("input", ()=>{
    Array.from(amountBtnsWrap.querySelectorAll(".pgt-btn-amount")).forEach(el=>el.setAttribute("aria-pressed","false"));
    state.amountSelected = null;
    updateNextButton();
  });

  nextBtn.addEventListener("click", ()=>{
    const url = buildNextURL();
    window.location.href = url;
  });

  // Boot: enforce hidden custom input on load, render defaults, then resolve currency via AJAX and re-render
  (async function init(){
    setCustomVisible(false);       // hidden on load
    renderFrequencyUI();
    renderAmountPresets();

    // Resolve geo currency from AJAX endpoint (GBP fallback). No inference beyond received code.
    const detectedCurrency = await fetchGeoCurrency(); // "USD" | "EUR" | "GBP"
    if(detectedCurrency && detectedCurrency !== state.currency){
      await onCurrencyChange(detectedCurrency);
    } else {
      // still fetch presets for initial GBP so grid is updated with live values
      state.amountPresets = await fetchPresets(state.currency);
      renderAmountPresets();
    }
  })();
})();
</script>
