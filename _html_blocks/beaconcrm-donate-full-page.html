<!-- PANGEA TRUST — DONATION FORM PAGE (paste into /donation-form/) -->
<!-- Loads the correct Beacon form by URL ?currency=XXX or via geo-IP. GBP is the safe fallback. -->
<!-- Author Amer Kawar -> https://wildamer.com -->

<div id="pgt-page" class="pgt-wrap">
  <!-- Top bar: currency selector on the left -->
  <div class="pgt-toolbar" role="region" aria-label="Donation settings">
    <label for="pgt-currency" class="pgt-label">Currency</label>
    <select id="pgt-currency" class="pgt-select" aria-label="Currency">
      <option value="GBP">GBP £</option>
      <option value="EUR">EUR €</option>
      <option value="USD">USD $</option>
    </select>
  </div>

  <!-- Form container (Beacon renders here) -->
  <div id="pgt-form-wrap" class="pgt-form-wrap">
    <!-- Beacon SDK (loads once; safe to include multiple times) -->
    <script>
      !function(d,i){
        if(!d.getElementById(i)){
          var s=d.createElement("script");
          s.id=i;s.async=true;
          s.src="https://static.beaconproducts.co.uk/js-sdk/production/beaconcrm.min.js";
          d.head.appendChild(s);
        }
      }(document,"beacon-js-sdk");
    </script>

    <!-- Beacon form goes here; we inject correct data-form via JS below -->
    <div id="pgt-beacon-slot"></div>
  </div>
</div>

<style>
/* Minimal, accessible layout */
#pgt-page { --pgt-border:#e5e7eb; --pgt-text:#111827; --pgt-sub:#6b7280; --pgt-bg:#fff; font-family:inherit; }
#pgt-page .pgt-toolbar{display:flex;align-items:center;justify-content:end;gap:10px;padding:14px 0;width:100%;}
#pgt-page .pgt-label{font-weight:600;color:var(--pgt-text)}
#pgt-page .pgt-select{border:1px solid var(--pgt-border);border-radius:8px;padding:8px 10px;background:#fff;font-weight:600}
#pgt-page .pgt-form-wrap{padding:6px 0}
@media (max-width:520px){
  #pgt-page .pgt-toolbar{flex-wrap:wrap}
}
</style>

<script>
(function(){
  // --- Config ---
  const ACCOUNT = "pangeatrust";
  const formsByCurrency = {
    GBP: "57085719",
    EUR: "694de004",
    USD: "17a36966"
  };
  const ALLOWED = Object.keys(formsByCurrency); // ["GBP","EUR","USD"]

  // --- Geo-IP currency ---
  async function fetchGeoCurrency(){
    const endpoint = "/wp-admin/admin-ajax.php?action=geoip_detect2_get_info_from_current_ip";
    try{
      const res = await fetch(endpoint, { credentials:"same-origin", cache:"no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const record = await res.json();
      // Use currencyCode; accept currency_code if the plugin returns snake_case
      const raw = record?.extra?.currencyCode ?? record?.extra?.currency_code ?? "";
      const code = String(raw).toUpperCase();
      return (code === "USD" || code === "EUR" || code === "GBP") ? code : "GBP";
    }catch(_e){
      return "GBP";
    }
  }

  // --- Elements ---
  const selectEl = document.getElementById("pgt-currency");
  const slot = document.getElementById("pgt-beacon-slot");

  // --- Helpers ---
  function getURLCurrency(){
    const cur = new URLSearchParams(location.search).get("currency");
    const code = (cur || "").toUpperCase();
    return ALLOWED.includes(code) ? code : null;
  }

  function setURLCurrency(cur){
    const url = new URL(location.href);
    url.searchParams.set("currency", cur);
    history.replaceState(null, "", url.toString());
  }

  function renderBeaconForm(cur){
    // Clear previous
    slot.innerHTML = "";
    // Create the Beacon form container with correct attributes
    const div = document.createElement("div");
    div.className = "beacon-form";
    div.setAttribute("data-account", ACCOUNT);
    div.setAttribute("data-form", formsByCurrency[cur]);
    slot.appendChild(div);

    // If SDK is present and exposes a render method, call it; otherwise it will auto-init.
    (window.BeaconCRM && typeof window.BeaconCRM.render === "function") && window.BeaconCRM.render();
  }

  // --- Init flow (updated #1 & #2) ---
  (async function init(){
    // 1) Prefer ?currency=XXX; else use geo-IP
    const urlCurrency = getURLCurrency();
    let currency = urlCurrency || await fetchGeoCurrency();

    // 2) Sync UI to detected currency and render the form
    selectEl.value = currency;
    renderBeaconForm(currency);
  })();

  // --- Events ---
  selectEl.addEventListener("change", function(){
    const cur = selectEl.value.toUpperCase();
    if(!ALLOWED.includes(cur)) return;
    // Only set the query string when the user explicitly changes the dropdown
    setURLCurrency(cur);
    renderBeaconForm(cur);
  });
})();
</script>
